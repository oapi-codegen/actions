name: CI
on:
  workflow_call:
    inputs:
      excluding_versions:
        description: 'List of Go versions to not run against, in a JSON array (e.g. ["1.21", "1.22"])'
        required: false
        type: string
        default: "[]"
      lint_versions:
        description: 'List of Go versions to lint against, in a JSON array (e.g. ["1.25"]). If empty, uses the same versions as the other jobs.'
        required: false
        type: string
        default: ""

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      go-versions: ${{ steps.versions.outputs.matrix }}
      lint-versions: ${{ steps.versions.outputs.lint_matrix }}
    steps:
      - id: versions
        run: |
          # versions of Go that this module can still be built with (and therefore are "supported" by this project) and actively supported versions of Go
          all_versions='["1.22", "1.23", "1.24", "1.25", "stable", "oldstable"]'
          excluding='${{ inputs.excluding_versions }}'

          # Filter out excluded versions using jq
          filtered=$(jq -c --argjson exclude "$excluding" '[.[] | select(. as $v | $exclude | index($v) | not)]' <<< "$all_versions")

          echo "matrix=$filtered" >> $GITHUB_OUTPUT

          # Use lint-specific versions if provided, otherwise fall back to the filtered matrix
          lint_override='${{ inputs.lint_versions }}'
          if [ -n "$lint_override" ]; then
            echo "lint_matrix=$lint_override" >> $GITHUB_OUTPUT
          else
            echo "lint_matrix=$filtered" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      fail-fast: false
      # perform matrix testing to give us an earlier insight into issues with different versions of supported major versions of Go
      matrix:
        version: ${{ fromJSON(needs.setup.outputs.go-versions) }}
    steps:
      - name: Check out source code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Set up Go
        uses: actions/setup-go@0aaccfd150d50ccaeb58ebd88d36e91967a5f35b # v5
        with:
          go-version: ${{ matrix.version }}

      - name: Test
        run: make test
        env:
          # A combination of our GitHub Actions setup, with the Go toolchain, leads to inconsistencies in calling `go env`, in particular with Go 1.21, where having (the default) `GOTOOLCHAIN=auto` results in build failures
          GOTOOLCHAIN: local

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJSON(needs.setup.outputs.lint-versions) }}
    steps:
      - name: Check out source code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Set up Go
        uses: actions/setup-go@0aaccfd150d50ccaeb58ebd88d36e91967a5f35b # v5
        with:
          go-version: ${{ matrix.version }}

      - name: Run `make lint-ci`
        run: make lint-ci
        env:
          # A combination of our GitHub Actions setup, with the Go toolchain, leads to inconsistencies in calling `go env`, in particular with Go 1.21, where having (the default) `GOTOOLCHAIN=auto` results in build failures
          GOTOOLCHAIN: local

  tidy:
    name: Go mod tidy
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJSON(needs.setup.outputs.go-versions) }}
    steps:
      - name: Check out source code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Set up Go
        uses: actions/setup-go@0aaccfd150d50ccaeb58ebd88d36e91967a5f35b # v5
        with:
          go-version: ${{ matrix.version }}

      - name: Install `tidied`
        run: go install gitlab.com/jamietanna/tidied@latest

      - name: Check for no untracked files
        run: tidied -verbose

  generate:
    name: Generated files
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJSON(needs.setup.outputs.go-versions) }}
    steps:
      - name: Check out source code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Set up Go
        uses: actions/setup-go@0aaccfd150d50ccaeb58ebd88d36e91967a5f35b # v5
        with:
          go-version: ${{ matrix.version }}

      - name: Run `make generate`
        run: make generate
        env:
          # A combination of our GitHub Actions setup, with the Go toolchain, leads to inconsistencies in calling `go env`, in particular with Go 1.21, where having (the default) `GOTOOLCHAIN=auto` results in build failures
          GOTOOLCHAIN: local

      - name: Check for no untracked files
        run: git status && git diff-index --quiet HEAD --

  check:
    name: CI
    runs-on: ubuntu-latest
    needs:
      - build
      - lint
      - tidy
      - generate
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "Build job failed or was cancelled"
            exit 1
          fi
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "Lint job failed or was cancelled"
            exit 1
          fi
          if [ "${{ needs.tidy.result }}" != "success" ]; then
            echo "Tidy job failed or was cancelled"
            exit 1
          fi
          if [ "${{ needs.generate.result }}" != "success" ]; then
            echo "Generate job failed or was cancelled"
            exit 1
          fi
          echo "All CI jobs passed"
